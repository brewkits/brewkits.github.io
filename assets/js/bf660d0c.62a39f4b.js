"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[6028],{1147(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"kmp/best-practices","title":"KMP Best Practices","description":"BrewKits\' recommended best practices for Kotlin Multiplatform development.","source":"@site/docs/kmp/best-practices.md","sourceDirName":"kmp","slug":"/kmp/best-practices","permalink":"/docs/kmp/best-practices","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Publishing KMP Libraries","permalink":"/docs/kmp/publishing"}}');var r=t(4848),s=t(8453);const i={sidebar_position:3},o="KMP Best Practices",l={},c=[{value:"Project Structure",id:"project-structure",level:2},{value:"1. Organize by Feature",id:"1-organize-by-feature",level:3},{value:"2. Shared Models in commonMain",id:"2-shared-models-in-commonmain",level:3},{value:"Code Sharing Strategies",id:"code-sharing-strategies",level:2},{value:"1. Maximize Common Code",id:"1-maximize-common-code",level:3},{value:"2. Use expect/actual for Platform APIs",id:"2-use-expectactual-for-platform-apis",level:3},{value:"3. Interfaces Over expect/actual",id:"3-interfaces-over-expectactual",level:3},{value:"Concurrency",id:"concurrency",level:2},{value:"1. Use Coroutines",id:"1-use-coroutines",level:3},{value:"2. StateFlow for State Management",id:"2-stateflow-for-state-management",level:3},{value:"Networking",id:"networking",level:2},{value:"1. Use Ktor for HTTP",id:"1-use-ktor-for-http",level:3},{value:"Data Persistence",id:"data-persistence",level:2},{value:"1. Use SQLDelight",id:"1-use-sqldelight",level:3},{value:"Testing",id:"testing",level:2},{value:"1. Shared Tests in commonTest",id:"1-shared-tests-in-commontest",level:3},{value:"2. Mock Platform Dependencies",id:"2-mock-platform-dependencies",level:3},{value:"Dependency Injection",id:"dependency-injection",level:2},{value:"Use Koin",id:"use-koin",level:3},{value:"Performance",id:"performance",level:2},{value:"1. Lazy Initialization",id:"1-lazy-initialization",level:3},{value:"2. Optimize expect/actual",id:"2-optimize-expectactual",level:3},{value:"Documentation",id:"documentation",level:2},{value:"KDoc Comments",id:"kdoc-comments",level:3},{value:"Resources",id:"resources",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"kmp-best-practices",children:"KMP Best Practices"})}),"\n",(0,r.jsx)(n.p,{children:"BrewKits' recommended best practices for Kotlin Multiplatform development."}),"\n",(0,r.jsx)(n.h2,{id:"project-structure",children:"Project Structure"}),"\n",(0,r.jsx)(n.h3,{id:"1-organize-by-feature",children:"1. Organize by Feature"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"src/\n\u251c\u2500\u2500 commonMain/\n\u2502   \u2514\u2500\u2500 kotlin/\n\u2502       \u2514\u2500\u2500 dev/brewkits/library/\n\u2502           \u251c\u2500\u2500 auth/\n\u2502           \u2502   \u251c\u2500\u2500 AuthService.kt\n\u2502           \u2502   \u251c\u2500\u2500 AuthRepository.kt\n\u2502           \u2502   \u2514\u2500\u2500 models/\n\u2502           \u251c\u2500\u2500 network/\n\u2502           \u2502   \u251c\u2500\u2500 ApiClient.kt\n\u2502           \u2502   \u2514\u2500\u2500 models/\n\u2502           \u2514\u2500\u2500 utils/\n\u251c\u2500\u2500 androidMain/\n\u2502   \u2514\u2500\u2500 kotlin/\n\u2502       \u2514\u2500\u2500 dev/brewkits/library/\n\u2502           \u251c\u2500\u2500 auth/\n\u2502           \u2502   \u2514\u2500\u2500 AuthService.android.kt\n\u2502           \u2514\u2500\u2500 network/\n\u2502               \u2514\u2500\u2500 ApiClient.android.kt\n\u2514\u2500\u2500 iosMain/\n    \u2514\u2500\u2500 kotlin/\n        \u2514\u2500\u2500 dev/brewkits/library/\n            \u251c\u2500\u2500 auth/\n            \u2502   \u2514\u2500\u2500 AuthService.ios.kt\n            \u2514\u2500\u2500 network/\n                \u2514\u2500\u2500 ApiClient.ios.kt\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-shared-models-in-commonmain",children:"2. Shared Models in commonMain"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:"// commonMain\ndata class User(\n    val id: String,\n    val name: String,\n    val email: String,\n    val createdAt: Long\n)\n\ndata class ApiResponse<T>(\n    val data: T?,\n    val error: String?,\n    val isSuccess: Boolean\n)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"code-sharing-strategies",children:"Code Sharing Strategies"}),"\n",(0,r.jsx)(n.h3,{id:"1-maximize-common-code",children:"1. Maximize Common Code"}),"\n",(0,r.jsxs)(n.p,{children:["Put as much as possible in ",(0,r.jsx)(n.code,{children:"commonMain"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'// \u2705 Good - pure Kotlin in commonMain\nclass UserValidator {\n    fun validateEmail(email: String): Boolean {\n        val emailRegex = "^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+$".toRegex()\n        return email.matches(emailRegex)\n    }\n\n    fun validatePassword(password: String): Boolean {\n        return password.length >= 8\n    }\n}\n\n// \u2705 Good - business logic shared\nclass AuthRepository(\n    private val apiClient: ApiClient,\n    private val storage: SecureStorage\n) {\n    suspend fun login(email: String, password: String): Result<User> {\n        return try {\n            val response = apiClient.post("/auth/login", mapOf(\n                "email" to email,\n                "password" to password\n            ))\n            storage.saveToken(response.token)\n            Result.success(response.user)\n        } catch (e: Exception) {\n            Result.failure(e)\n        }\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"2-use-expectactual-for-platform-apis",children:"2. Use expect/actual for Platform APIs"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'// commonMain\nexpect class SecureStorage {\n    fun saveToken(token: String)\n    fun getToken(): String?\n    fun clearToken()\n}\n\n// androidMain\nimport android.content.Context\nimport androidx.security.crypto.EncryptedSharedPreferences\nimport androidx.security.crypto.MasterKey\n\nactual class SecureStorage(context: Context) {\n    private val masterKey = MasterKey.Builder(context)\n        .setKeyScheme(MasterKey.KeyScheme.AES256_GCM)\n        .build()\n\n    private val prefs = EncryptedSharedPreferences.create(\n        context,\n        "secure_prefs",\n        masterKey,\n        EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,\n        EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM\n    )\n\n    actual fun saveToken(token: String) {\n        prefs.edit().putString("auth_token", token).apply()\n    }\n\n    actual fun getToken(): String? {\n        return prefs.getString("auth_token", null)\n    }\n\n    actual fun clearToken() {\n        prefs.edit().remove("auth_token").apply()\n    }\n}\n\n// iosMain\nimport platform.Foundation.NSUserDefaults\n\nactual class SecureStorage {\n    private val keychain = /* Keychain wrapper */\n\n    actual fun saveToken(token: String) {\n        keychain.set(token, forKey = "auth_token")\n    }\n\n    actual fun getToken(): String? {\n        return keychain.string(forKey = "auth_token")\n    }\n\n    actual fun clearToken() {\n        keychain.delete(forKey = "auth_token")\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"3-interfaces-over-expectactual",children:"3. Interfaces Over expect/actual"}),"\n",(0,r.jsx)(n.p,{children:"Prefer interfaces when possible:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'// commonMain\ninterface Logger {\n    fun log(message: String)\n    fun error(message: String, throwable: Throwable?)\n}\n\nclass DefaultLogger : Logger {\n    override fun log(message: String) {\n        println(message)\n    }\n\n    override fun error(message: String, throwable: Throwable?) {\n        println("ERROR: $message")\n        throwable?.printStackTrace()\n    }\n}\n\n// Dependency injection\nclass UserService(\n    private val logger: Logger = DefaultLogger()\n) {\n    fun processUser(user: User) {\n        logger.log("Processing user: ${user.name}")\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"concurrency",children:"Concurrency"}),"\n",(0,r.jsx)(n.h3,{id:"1-use-coroutines",children:"1. Use Coroutines"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'class DataRepository(\n    private val api: ApiClient,\n    private val cache: Cache\n) {\n    suspend fun fetchData(): Result<Data> = withContext(Dispatchers.IO) {\n        try {\n            // Try cache first\n            cache.get("data")?.let { cached ->\n                return@withContext Result.success(cached)\n            }\n\n            // Fetch from network\n            val response = api.getData()\n            cache.set("data", response)\n            Result.success(response)\n        } catch (e: Exception) {\n            Result.failure(e)\n        }\n    }\n\n    fun observeData(): Flow<Data> = flow {\n        while (true) {\n            val data = fetchData().getOrNull()\n            data?.let { emit(it) }\n            delay(5000) // Poll every 5 seconds\n        }\n    }.flowOn(Dispatchers.IO)\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"2-stateflow-for-state-management",children:"2. StateFlow for State Management"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:"class UserViewModel {\n    private val _userState = MutableStateFlow<UserState>(UserState.Initial)\n    val userState: StateFlow<UserState> = _userState.asStateFlow()\n\n    fun login(email: String, password: String) {\n        viewModelScope.launch {\n            _userState.value = UserState.Loading\n\n            val result = authRepository.login(email, password)\n\n            _userState.value = when {\n                result.isSuccess -> UserState.Success(result.getOrNull()!!)\n                else -> UserState.Error(result.exceptionOrNull()?.message)\n            }\n        }\n    }\n}\n\nsealed class UserState {\n    object Initial : UserState()\n    object Loading : UserState()\n    data class Success(val user: User) : UserState()\n    data class Error(val message: String?) : UserState()\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"networking",children:"Networking"}),"\n",(0,r.jsx)(n.h3,{id:"1-use-ktor-for-http",children:"1. Use Ktor for HTTP"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'// commonMain\nclass ApiClient {\n    private val client = HttpClient {\n        install(ContentNegotiation) {\n            json(Json {\n                ignoreUnknownKeys = true\n                isLenient = true\n            })\n        }\n\n        install(Logging) {\n            logger = Logger.DEFAULT\n            level = LogLevel.INFO\n        }\n\n        defaultRequest {\n            url("https://api.brewkits.dev/v1/")\n            header(HttpHeaders.ContentType, ContentType.Application.Json)\n        }\n    }\n\n    suspend fun <T> get(\n        endpoint: String,\n        responseType: KClass<T>\n    ): T {\n        return client.get(endpoint).body()\n    }\n\n    suspend fun <T> post(\n        endpoint: String,\n        body: Any,\n        responseType: KClass<T>\n    ): T {\n        return client.post(endpoint) {\n            setBody(body)\n        }.body()\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"data-persistence",children:"Data Persistence"}),"\n",(0,r.jsx)(n.h3,{id:"1-use-sqldelight",children:"1. Use SQLDelight"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'// commonMain\nclass UserDatabase(driver: SqlDriver) {\n    private val database = Database(driver)\n\n    fun insertUser(user: User) {\n        database.userQueries.insert(\n            id = user.id,\n            name = user.name,\n            email = user.email\n        )\n    }\n\n    fun getUser(id: String): User? {\n        return database.userQueries.selectById(id).executeAsOneOrNull()?.let {\n            User(\n                id = it.id,\n                name = it.name,\n                email = it.email\n            )\n        }\n    }\n\n    fun observeUsers(): Flow<List<User>> {\n        return database.userQueries.selectAll()\n            .asFlow()\n            .mapToList()\n            .map { list -> list.map { /* map to User */ } }\n    }\n}\n\n// androidMain\nactual class DatabaseDriverFactory(private val context: Context) {\n    actual fun createDriver(): SqlDriver {\n        return AndroidSqliteDriver(\n            Database.Schema,\n            context,\n            "brewkits.db"\n        )\n    }\n}\n\n// iosMain\nactual class DatabaseDriverFactory {\n    actual fun createDriver(): SqlDriver {\n        return NativeSqliteDriver(\n            Database.Schema,\n            "brewkits.db"\n        )\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,r.jsx)(n.h3,{id:"1-shared-tests-in-commontest",children:"1. Shared Tests in commonTest"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'class UserValidatorTest {\n    private val validator = UserValidator()\n\n    @Test\n    fun `valid email should return true`() {\n        assertTrue(validator.validateEmail("test@brewkits.dev"))\n    }\n\n    @Test\n    fun `invalid email should return false`() {\n        assertFalse(validator.validateEmail("invalid-email"))\n    }\n\n    @Test\n    fun `password with 8+ chars should be valid`() {\n        assertTrue(validator.validatePassword("password123"))\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"2-mock-platform-dependencies",children:"2. Mock Platform Dependencies"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'class MockSecureStorage : SecureStorage {\n    private val storage = mutableMapOf<String, String>()\n\n    override fun saveToken(token: String) {\n        storage["auth_token"] = token\n    }\n\n    override fun getToken(): String? {\n        return storage["auth_token"]\n    }\n\n    override fun clearToken() {\n        storage.remove("auth_token")\n    }\n}\n\nclass AuthRepositoryTest {\n    private val mockStorage = MockSecureStorage()\n    private val mockApi = MockApiClient()\n    private val repository = AuthRepository(mockApi, mockStorage)\n\n    @Test\n    fun `login should save token`() = runTest {\n        val result = repository.login("test@brewkits.dev", "password123")\n\n        assertTrue(result.isSuccess)\n        assertNotNull(mockStorage.getToken())\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"dependency-injection",children:"Dependency Injection"}),"\n",(0,r.jsx)(n.h3,{id:"use-koin",children:"Use Koin"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:"// commonMain\nval appModule = module {\n    single<Logger> { DefaultLogger() }\n    single { ApiClient() }\n    single { SecureStorage() }\n    single { AuthRepository(get(), get()) }\n    factory { UserViewModel(get()) }\n}\n\n// Initialize in app\nfun initKoin() {\n    startKoin {\n        modules(appModule)\n    }\n}\n\n// Usage\nclass MyScreen {\n    private val viewModel: UserViewModel by inject()\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"performance",children:"Performance"}),"\n",(0,r.jsx)(n.h3,{id:"1-lazy-initialization",children:"1. Lazy Initialization"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:"class HeavyResource {\n    companion object {\n        val instance: HeavyResource by lazy {\n            HeavyResource().apply {\n                // Expensive initialization\n            }\n        }\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-optimize-expectactual",children:"2. Optimize expect/actual"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:"// \u274c Bad - separate expect/actual for each function\nexpect fun getCurrentTime(): Long\nexpect fun formatTime(time: Long): String\nexpect fun parseTime(str: String): Long\n\n// \u2705 Good - single interface\nexpect class TimeUtil {\n    fun getCurrentTime(): Long\n    fun formatTime(time: Long): String\n    fun parseTime(str: String): Long\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"documentation",children:"Documentation"}),"\n",(0,r.jsx)(n.h3,{id:"kdoc-comments",children:"KDoc Comments"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:"/**\n * Manages user authentication and authorization.\n *\n * This repository handles login, logout, and token management\n * across all supported platforms.\n *\n * @property apiClient The API client for network requests\n * @property storage Secure storage for tokens\n *\n * @constructor Creates an AuthRepository with the given dependencies\n */\nclass AuthRepository(\n    private val apiClient: ApiClient,\n    private val storage: SecureStorage\n) {\n    /**\n     * Authenticates a user with email and password.\n     *\n     * @param email User's email address\n     * @param password User's password\n     * @return Result containing the authenticated User or an error\n     *\n     * @throws NetworkException if network request fails\n     */\n    suspend fun login(email: String, password: String): Result<User> {\n        // Implementation\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"resources",children:"Resources"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://kotlinlang.org/docs/multiplatform-best-practices.html",children:"Kotlin Multiplatform Best Practices"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://touchlab.co/kmp-best-practices",children:"Touchlab KMP Guide"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/Kotlin/kmm-samples",children:"JetBrains KMP Samples"})}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.em,{children:"Build robust, maintainable KMP libraries!"})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>i,x:()=>o});var a=t(6540);const r={},s=a.createContext(r);function i(e){const n=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);